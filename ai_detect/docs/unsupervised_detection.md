# 无监督异常检测方法说明

本文档介绍了TinyLogBERT模型集成的无监督异常检测方法，替代了原有基于MLP的AnomalyScoreHead。

## 1. 实现的无监督检测方法

我们实现了以下几种常用的无监督异常检测方法：

### 1.1 K-近邻 (KNN)

- **原理**：计算样本与训练集中K个最近邻样本的平均距离作为异常分数
- **优势**：简单直观，计算效率高
- **适用场景**：数据分布较均匀，正常样本聚集成簇的情况

### 1.2 聚类距离 (Cluster)

- **原理**：使用K-means聚类算法将样本聚为多个簇，计算样本到最近簇中心的距离作为异常分数
- **优势**：可以处理多模态数据，适应复杂分布
- **适用场景**：日志有明显的模式分组，不同类型日志形成不同簇

### 1.3 局部异常因子 (LOF)

- **原理**：计算样本局部密度与其邻居的局部密度比较，密度明显低于邻居的样本被视为异常
- **优势**：能够检测局部异常，适应不同密度区域
- **适用场景**：数据密度不均匀，有密集区域和稀疏区域

### 1.4 孤立森林 (Isolation Forest)

- **原理**：随机构建决策树，孤立点被隔离所需步骤较少，因此异常样本有更短的路径长度
- **优势**：高效，不依赖距离计算，适用于高维数据
- **适用场景**：大规模数据集，需要快速检测异常

### 1.5 重构误差 (Reconstruction)

- **原理**：使用自编码器将[CLS]向量编码到低维瓶颈层再重构，计算重构误差作为异常分数
- **优势**：可以学习数据的内在结构和关系
- **适用场景**：日志有复杂的语义关系，简单距离计算难以区分

## 2. 使用方法

### 2.1 训练时指定检测方法

```bash
python ai_detect/train.py --train_file logs/train.log --detection_method knn
```

可选的检测方法有：`knn`, `cluster`, `lof`, `iforest`, `reconstruction`

### 2.2 评估多种方法

```bash
python ai_detect/train.py --train_file logs/train.log --eval_file logs/test.jsonl --eval_all_methods
```

这将训练一个模型，并使用所有无监督方法进行评估比较。

### 2.3 在代码中切换检测方法

```python
from ai_detect.anomaly_detector import AnomalyDetector

# 初始化检测器
detector = AnomalyDetector(detection_method="knn")

# 加载模型后切换检测方法
detector.model.set_detection_method("lof")

# 进行预测
result = detector.detect(log_text, method="iforest")  # 临时使用isolaton forest
```

## 3. 检测器内存管理

无监督检测器使用了内存管理机制，保存用于拟合的样本特征：

1. 训练后自动收集一定数量样本特征进行拟合
2. 特征内存大小默认限制为10000个样本
3. 预测时可更新内存（默认关闭）
4. 当超出内存大小限制时，随机替换策略保持内存大小恒定

## 4. 性能比较

不同检测方法在不同类型的日志数据上表现各异：

| 检测方法 | 计算速度 | 内存需求 | 适用数据规模 | 适用数据分布 |
|---------|---------|---------|------------|------------|
| KNN | 中等 | 中等 | 小到中等 | 均匀分布 |
| Cluster | 快 | 低 | 大 | 多簇分布 |
| LOF | 慢 | 高 | 小到中等 | 不均匀密度 |
| IForest | 非常快 | 低 | 非常大 | 各种分布 |
| Reconstruction | 中等 | 中等 | 各种规模 | 复杂语义关系 |

## 5. 最佳实践

1. **选择合适的检测方法**：不同日志数据适合不同检测方法，建议使用`--eval_all_methods`对比选择最佳方法

2. **特征收集**：首次训练后会自动收集特征并拟合检测器，确保提供足够多的正常样本

3. **阈值调整**：无监督方法的异常分数范围可能不同，通过`evaluate`方法自动寻找最佳阈值

4. **增量更新**：如需要增量适应新数据，可在预测时设置`update_memory=True`更新特征库 