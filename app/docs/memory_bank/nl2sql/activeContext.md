# NL2SQL 活跃上下文

## 当前工作重点

我们目前正专注于以下关键领域：

1. **NL2SQL转换器的错误处理**：
   - 修复当API密钥为空时的空对象strip()调用导致的错误
   - 解决复杂查询出错时的回退机制优化
   - 改进LLM生成SQL语法错误的检测与纠正

2. **实体识别增强**：
   - 扩展常见实体的识别模式（用户名、IP、事件类型）
   - 改进日志特有术语的识别精度
   - 提高文本中隐含实体的提取能力

3. **UI体验优化**：
   - 完善nlp_sql.html界面布局和交互体验
   - 添加查询历史功能
   - 实现结果可视化展示

4. **多语言支持**：
   - 确保中英文混合查询的可靠处理
   - 准备常见查询模式的中文示例库

## 最近变更

### 代码变更

1. **2023-04-06**：修复API密钥检查逻辑中的空对象错误
   ```python
   # 修复前
   if not os.environ.get("OPENROUTER_API_KEY") or os.environ.get("OPENROUTER_API_KEY").strip() == "":
       # 可能导致NoneType没有strip()方法的错误
       
   # 修复后
   api_key = os.environ.get("OPENROUTER_API_KEY", "")
   if not api_key or api_key.strip() == "":
       # 安全处理
   ```

2. **2023-04-05**：增强实体匹配函数以支持更多变体
   ```python
   # 增加了更多用户名匹配模式
   user_patterns.extend([
       f"logged in as {value}",
       f"user: {value}",
       f"username: {value}"
   ])
   ```

3. **2023-04-03**：改进时间表达式解析
   ```python
   # 添加对"上个月"、"本季度"等表达的支持
   if time_expr == "上个月":
       # 处理逻辑
   elif time_expr == "本季度":
       # 处理逻辑
   ```

### 接口变更

1. **2023-04-04**：nlp_query API响应添加置信度
   ```json
   {
       "sql": "SELECT...",
       "results": [...],
       "original_query": "...",
       "confidence": 0.92
   }
   ```

2. **2023-04-02**：为API添加CORS支持，允许跨域请求

## 下一步计划

1. **短期目标**（1-2周内）：
   - 完成API错误处理的全面审查与修复
   - 添加单元测试，提高代码覆盖率
   - 实现查询历史记录功能

2. **中期目标**（1个月内）：
   - 增加异常模式查询的特殊支持
   - 实现复杂的多表联合查询优化
   - 添加查询模板功能，支持保存常用查询

3. **长期目标**（3个月内）：
   - 实现SQL结果的可视化展示
   - 支持自定义表结构的动态加载
   - 开发用户反馈机制，用于持续改进转换质量

## 活跃决策与考量

1. **API依赖降低策略**：
   - **当前决策**：保留两种转换策略（API和模式匹配），但继续改进模式匹配方案的质量
   - **考量**：
     - 模式匹配方案难以覆盖所有复杂查询场景
     - LLM API成本较高，但质量更好
     - 尚未决定是否投入资源开发本地轻量级模型

2. **数据库结构变更适应**：
   - **当前决策**：通过TABLE_SCHEMA常量定义表结构，变更时需手动更新
   - **考量**：
     - 探索自动从数据库读取表结构的可行性
     - 权衡自动化与安全性的利弊
     - 考虑添加表结构版本控制机制

3. **查询历史与个性化**：
   - **当前决策**：实现基础的查询历史记录功能
   - **考量**：
     - 是否需要用户登录来保存个人查询历史
     - 如何基于历史查询改进自然语言理解
     - 隐私问题与数据存储策略

4. **错误处理策略**：
   - **当前决策**：采用多层错误处理机制，包括预检查、异常捕获和回退方案
   - **考量**：
     - 平衡用户友好的错误信息与安全考虑
     - SQL执行错误的处理方式（重试、建议修正、降级查询）
     - 是否向用户显示生成的SQL错误详情

## 当前挑战

1. **查询复杂度与性能平衡**：
   - 复杂查询生成质量高但执行效率低
   - 需要在SQL生成时考虑性能优化

2. **多种日志格式适配**：
   - 不同来源的日志格式差异大
   - 实体识别需适应多种表示形式

3. **API可靠性与成本**：
   - OpenRouter API偶有中断或延迟
   - 随着使用量增加，API成本控制成为考量点

4. **查询意图理解准确性**：
   - 模糊或隐含的查询意图理解仍有提升空间
   - 特别是涉及复杂条件组合的查询 