# NL2SQL产品上下文

## 为什么需要NL2SQL模块？

安全日志分析通常需要掌握SQL查询语言和深入了解数据库结构，这对非技术人员形成了较高的门槛。NL2SQL模块通过自然语言处理技术，让非技术用户能够以直观的自然语言提问方式查询复杂的安全日志数据，大幅降低了日志分析的技术门槛。

## 解决的核心问题

1. **技能障碍**：安全人员通常专注于安全分析而非SQL编写，NL2SQL弥合了这一技能缺口
2. **效率提升**：编写复杂SQL查询耗时且容易出错，自然语言查询可以在几秒内完成同样的工作
3. **查询灵活性**：可以理解各种自然表达方式描述的相同查询意图
4. **上下文感知**：理解"今天"、"最近一周"等相对时间表达，自动转换为精确的时间范围
5. **多表关联**：自动处理多表关联查询，无需用户了解表之间的关系

## 工作原理

NL2SQL模块的核心工作流程如下：

1. **查询预处理**：
   - 解析时间表达式（如"最近24小时"、"上周"、"从昨天到今天"）
   - 识别用户名、IP地址、事件类型等关键实体
   - 分析查询意图（是查询日志、异常还是规则）

2. **转换生成**：
   - 一级转换：使用OpenRouter API调用LLM将预处理后的查询转为SQL
   - 二级转换：如果API不可用，则使用内置的模式匹配进行转换

3. **查询优化**：
   - 实体增强：扩展匹配模式（例如用户名可能以多种格式出现在日志中）
   - 多表关联：根据查询意图自动添加必要的JOIN语句
   - 性能优化：添加适当的WHERE条件和索引提示

4. **执行与展示**：
   - 执行生成的SQL查询
   - 将结果格式化为易于理解的形式
   - 展示SQL和结果，方便用户理解和学习

## 用户体验目标

1. **简单易用**：用户无需了解SQL或数据库结构即可进行复杂查询
2. **容错能力**：能够理解不严格的自然语言表达，包括口语化表达
3. **透明反馈**：显示生成的SQL查询，帮助用户理解系统如何解释其意图
4. **学习曲线平缓**：新用户可以立即开始使用，随着使用不断学习更高级的查询技巧
5. **响应迅速**：从输入查询到显示结果的全过程应当在3秒内完成（不含API调用时间）

## 主要用户场景

1. **安全分析师**：快速查询可疑活动和安全事件
2. **IT管理员**：监控系统活动和用户行为
3. **安全审计人员**：收集特定时间段的安全事件证据
4. **安全运营团队**：日常安全监控和事件响应

## 与其他模块的关系

NL2SQL模块与系统其他部分有以下关键交互：

- 接收自**Web界面**传入的自然语言查询
- 使用**数据库连接模块**执行生成的SQL查询
- 为**异常检测模块**提供查询支持，帮助分析异常行为
- 与**日志解析模块**协同工作，确保对日志字段的准确理解 