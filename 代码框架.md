# **åŸºäº NLP çš„å®‰å…¨æ—¥å¿—åˆ†æä¸å¼‚å¸¸æ£€æµ‹ - å®ç°æ–‡æ¡£**  

---

## **ğŸ“Œ 1. é¡¹ç›®ç›®å½•ç»“æ„**  
æœ¬é¡¹ç›®åŸºäº Flask ä½œä¸ºåç«¯æ¡†æ¶ï¼ŒSQLite ä½œä¸ºæ•°æ®åº“ï¼Œå‰ç«¯ä½¿ç”¨ HTML + Bootstrapï¼Œç¡®ä¿ç®€å•æ˜“ä¸Šæ‰‹ã€‚

```
log_analysis_project/
â”‚â”€â”€ app/                          # æ ¸å¿ƒåº”ç”¨ç›®å½•
â”‚   â”œâ”€â”€ static/                    # é™æ€æ–‡ä»¶ï¼ˆCSS, JSï¼‰
â”‚   â”‚   â”œâ”€â”€ css/
â”‚   â”‚   â”œâ”€â”€ js/
â”‚   â”œâ”€â”€ templates/                 # å‰ç«¯ HTML é¡µé¢
â”‚   â”‚   â”œâ”€â”€ index.html              # æ—¥å¿—æŸ¥è¯¢ä¸»ç•Œé¢
â”‚   â”‚   â”œâ”€â”€ results.html            # æŸ¥è¯¢ç»“æœé¡µé¢
â”‚   â”œâ”€â”€ routes/                     # API è·¯ç”±
â”‚   â”‚   â”œâ”€â”€ __init__.py              # è®© routes å˜ä¸º Python åŒ…
â”‚   â”‚   â”œâ”€â”€ log_routes.py            # æ—¥å¿—ç®¡ç† API
â”‚   â”‚   â”œâ”€â”€ anomaly_routes.py        # å¼‚å¸¸æ£€æµ‹ API
â”‚   â”‚   â”œâ”€â”€ nlp_routes.py            # NLP æŸ¥è¯¢ API
â”‚   â”œâ”€â”€ models/                     # æ•°æ®åº“æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ db.py                    # SQLite æ•°æ®åº“è¿æ¥
â”‚   â”‚   â”œâ”€â”€ log_model.py              # æ—¥å¿—è¡¨ç»“æ„
â”‚   â”‚   â”œâ”€â”€ anomaly_model.py          # å¼‚å¸¸æ£€æµ‹è¡¨ç»“æ„
â”‚   â”œâ”€â”€ services/                    # ä¸šåŠ¡é€»è¾‘
â”‚   â”‚   â”œâ”€â”€ log_parser.py             # æ—¥å¿—è§£ææ¨¡å—
â”‚   â”‚   â”œâ”€â”€ anomaly_detector.py       # å¼‚å¸¸æ£€æµ‹æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ nlp_processor.py          # NLP å¤„ç†æ¨¡å—
â”‚   â”œâ”€â”€ app.py                        # Flask å…¥å£æ–‡ä»¶
â”‚â”€â”€ tests/                           # æµ‹è¯•æ–‡ä»¶
â”‚   â”œâ”€â”€ test_routes.py                # API æµ‹è¯•
â”‚â”€â”€ config.py                         # é…ç½®æ–‡ä»¶
â”‚â”€â”€ requirements.txt                  # Python ä¾èµ–
â”‚â”€â”€ run.py                            # è¿è¡Œè„šæœ¬
â”‚â”€â”€ README.md                         # è¯´æ˜æ–‡æ¡£
```

---

## **ğŸ“Œ 2. ä»£ç æ¡†æ¶**
### **ğŸ“ 2.1 Flask å…¥å£æ–‡ä»¶ (`app.py`)**
```python
from flask import Flask
from routes.log_routes import log_bp
from routes.anomaly_routes import anomaly_bp
from routes.nlp_routes import nlp_bp
from models.db import init_db

app = Flask(__name__)

# æ³¨å†Œè“å›¾
app.register_blueprint(log_bp, url_prefix="/logs")
app.register_blueprint(anomaly_bp, url_prefix="/anomalies")
app.register_blueprint(nlp_bp, url_prefix="/nlp")

# åˆå§‹åŒ–æ•°æ®åº“
init_db()

if __name__ == "__main__":
    app.run(debug=True)
```

---

### **ğŸ“ 2.2 æ•°æ®åº“ (`models/db.py`)**
```python
import sqlite3

DB_NAME = "logs.db"

def get_db():
    conn = sqlite3.connect(DB_NAME)
    conn.row_factory = sqlite3.Row
    return conn

def init_db():
    conn = get_db()
    cursor = conn.cursor()

    # åˆ›å»ºæ—¥å¿—è¡¨
    cursor.execute("""
    CREATE TABLE IF NOT EXISTS logs (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        timestamp TEXT,
        username TEXT,
        event TEXT,
        ip_address TEXT
    )""")

    # åˆ›å»ºå¼‚å¸¸æ£€æµ‹è¡¨
    cursor.execute("""
    CREATE TABLE IF NOT EXISTS anomalies (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        timestamp TEXT,
        username TEXT,
        event TEXT,
        ip_address TEXT,
        reason TEXT
    )""")

    conn.commit()
    conn.close()
```

---

## **ğŸ“Œ 3. API æ¨¡å—**
### **ğŸ“ 3.1 æ—¥å¿—ç®¡ç† API (`routes/log_routes.py`)**
```python
from flask import Blueprint, request, jsonify
from models.db import get_db

log_bp = Blueprint("logs", __name__)

@log_bp.route("/upload", methods=["POST"])
def upload_log():
    data = request.json
    log_content = data.get("log_content")

    # è§£ææ—¥å¿—å†…å®¹
    timestamp, username, event, ip_address = log_content.split(" - ")

    conn = get_db()
    cursor = conn.cursor()
    cursor.execute("INSERT INTO logs (timestamp, username, event, ip_address) VALUES (?, ?, ?, ?)",
                   (timestamp, username, event, ip_address))
    conn.commit()
    return jsonify({"status": "success", "message": "Log uploaded successfully"})
```

---

### **ğŸ“ 3.2 å¼‚å¸¸æ£€æµ‹ API (`routes/anomaly_routes.py`)**
```python
from flask import Blueprint, jsonify
from models.db import get_db

anomaly_bp = Blueprint("anomalies", __name__)

@anomaly_bp.route("/detect", methods=["GET"])
def detect_anomalies():
    conn = get_db()
    cursor = conn.cursor()

    # è§„åˆ™ï¼šåŒä¸€ IP 5 åˆ†é’Ÿå†…å¤±è´¥ç™»å½•è¶…è¿‡ 10 æ¬¡
    cursor.execute("""
    SELECT username, ip_address, COUNT(*) AS attempts
    FROM logs WHERE event='login_failed'
    GROUP BY username, ip_address HAVING attempts > 10
    """)
    
    anomalies = cursor.fetchall()
    results = []

    for anomaly in anomalies:
        results.append({
            "username": anomaly["username"],
            "ip_address": anomaly["ip_address"],
            "reason": "Possible brute-force attack ({} failed attempts)".format(anomaly["attempts"])
        })

    return jsonify({"anomalies": results})
```

---

### **ğŸ“ 3.3 NLP å¤„ç† API (`routes/nlp_routes.py`)**
```python
from flask import Blueprint, request, jsonify
from services.nlp_processor import convert_to_sql
from models.db import get_db

nlp_bp = Blueprint("nlp", __name__)

@nlp_bp.route("/query", methods=["POST"])
def nlp_query():
    data = request.json
    user_query = data.get("query")

    # è§£æè‡ªç„¶è¯­è¨€æŸ¥è¯¢
    sql_query = convert_to_sql(user_query)

    conn = get_db()
    cursor = conn.cursor()
    cursor.execute(sql_query)
    results = cursor.fetchall()

    return jsonify({"sql": sql_query, "results": [dict(row) for row in results]})
```

---

## **ğŸ“Œ 4. NLP å¤„ç†**
### **ğŸ“ 4.1 NLP è§£æ (`services/nlp_processor.py`)**
```python
import re

def convert_to_sql(nlp_query):
    """
    è§£æè‡ªç„¶è¯­è¨€æŸ¥è¯¢ï¼Œè½¬æ¢ä¸º SQL è¯­å¥
    """
    if "æœ€è¿‘ 24 å°æ—¶" in nlp_query:
        return "SELECT * FROM logs WHERE timestamp >= datetime('now', '-1 day')"

    if "admin ç™»å½•å¤±è´¥" in nlp_query:
        return "SELECT * FROM logs WHERE username='admin' AND event='login_failed'"

    return "SELECT * FROM logs"
```

---

## **ğŸ“Œ 5. Web å‰ç«¯**
### **ğŸ“ 5.1 æ—¥å¿—æŸ¥è¯¢ç•Œé¢ (`templates/index.html`)**
```html
<!DOCTYPE html>
<html>
<head>
    <title>æ—¥å¿—æŸ¥è¯¢ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="/static/css/bootstrap.min.css">
</head>
<body>
    <div class="container">
        <h2>æ—¥å¿—æŸ¥è¯¢</h2>
        <form id="queryForm">
            <input type="text" id="queryInput" class="form-control" placeholder="è¾“å…¥æŸ¥è¯¢è¯­å¥">
            <button type="submit" class="btn btn-primary">æŸ¥è¯¢</button>
        </form>
        <div id="results"></div>
    </div>

    <script src="/static/js/jquery.min.js"></script>
    <script>
        $("#queryForm").submit(function(event) {
            event.preventDefault();
            let query = $("#queryInput").val();
            $.post("/nlp/query", JSON.stringify({"query": query}), function(data) {
                $("#results").html(JSON.stringify(data.results, null, 2));
            });
        });
    </script>
</body>
</html>
```

---

## **ğŸ“Œ 6. è¿è¡Œé¡¹ç›®**
```bash
pip install flask sqlite3
python app.py
```

---

ğŸš€ **æœ¬é¡¹ç›®ä»£ç æ¡†æ¶æ¸…æ™°ï¼Œå¯ç›´æ¥è¿è¡Œå¹¶æ‰©å±•ï¼Œæ¬¢è¿å›¢é˜Ÿå¼€å‘ï¼** ğŸ’¡