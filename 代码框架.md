# **基于 NLP 的安全日志分析与异常检测 - 实现文档**  

---

## **📌 1. 项目目录结构**  
本项目基于 Flask 作为后端框架，SQLite 作为数据库，前端使用 HTML + Bootstrap，确保简单易上手。

```
log_analysis_project/
│── app/                          # 核心应用目录
│   ├── static/                    # 静态文件（CSS, JS）
│   │   ├── css/
│   │   ├── js/
│   ├── templates/                 # 前端 HTML 页面
│   │   ├── index.html              # 日志查询主界面
│   │   ├── results.html            # 查询结果页面
│   ├── routes/                     # API 路由
│   │   ├── __init__.py              # 让 routes 变为 Python 包
│   │   ├── log_routes.py            # 日志管理 API
│   │   ├── anomaly_routes.py        # 异常检测 API
│   │   ├── nlp_routes.py            # NLP 查询 API
│   ├── models/                     # 数据库模型
│   │   ├── db.py                    # SQLite 数据库连接
│   │   ├── log_model.py              # 日志表结构
│   │   ├── anomaly_model.py          # 异常检测表结构
│   ├── services/                    # 业务逻辑
│   │   ├── log_parser.py             # 日志解析模块
│   │   ├── anomaly_detector.py       # 异常检测模块
│   │   ├── nlp_processor.py          # NLP 处理模块
│   ├── app.py                        # Flask 入口文件
│── tests/                           # 测试文件
│   ├── test_routes.py                # API 测试
│── config.py                         # 配置文件
│── requirements.txt                  # Python 依赖
│── run.py                            # 运行脚本
│── README.md                         # 说明文档
```

---

## **📌 2. 代码框架**
### **📍 2.1 Flask 入口文件 (`app.py`)**
```python
from flask import Flask
from routes.log_routes import log_bp
from routes.anomaly_routes import anomaly_bp
from routes.nlp_routes import nlp_bp
from models.db import init_db

app = Flask(__name__)

# 注册蓝图
app.register_blueprint(log_bp, url_prefix="/logs")
app.register_blueprint(anomaly_bp, url_prefix="/anomalies")
app.register_blueprint(nlp_bp, url_prefix="/nlp")

# 初始化数据库
init_db()

if __name__ == "__main__":
    app.run(debug=True)
```

---

### **📍 2.2 数据库 (`models/db.py`)**
```python
import sqlite3

DB_NAME = "logs.db"

def get_db():
    conn = sqlite3.connect(DB_NAME)
    conn.row_factory = sqlite3.Row
    return conn

def init_db():
    conn = get_db()
    cursor = conn.cursor()

    # 创建日志表
    cursor.execute("""
    CREATE TABLE IF NOT EXISTS logs (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        timestamp TEXT,
        username TEXT,
        event TEXT,
        ip_address TEXT
    )""")

    # 创建异常检测表
    cursor.execute("""
    CREATE TABLE IF NOT EXISTS anomalies (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        timestamp TEXT,
        username TEXT,
        event TEXT,
        ip_address TEXT,
        reason TEXT
    )""")

    conn.commit()
    conn.close()
```

---

## **📌 3. API 模块**
### **📍 3.1 日志管理 API (`routes/log_routes.py`)**
```python
from flask import Blueprint, request, jsonify
from models.db import get_db

log_bp = Blueprint("logs", __name__)

@log_bp.route("/upload", methods=["POST"])
def upload_log():
    data = request.json
    log_content = data.get("log_content")

    # 解析日志内容
    timestamp, username, event, ip_address = log_content.split(" - ")

    conn = get_db()
    cursor = conn.cursor()
    cursor.execute("INSERT INTO logs (timestamp, username, event, ip_address) VALUES (?, ?, ?, ?)",
                   (timestamp, username, event, ip_address))
    conn.commit()
    return jsonify({"status": "success", "message": "Log uploaded successfully"})
```

---

### **📍 3.2 异常检测 API (`routes/anomaly_routes.py`)**
```python
from flask import Blueprint, jsonify
from models.db import get_db

anomaly_bp = Blueprint("anomalies", __name__)

@anomaly_bp.route("/detect", methods=["GET"])
def detect_anomalies():
    conn = get_db()
    cursor = conn.cursor()

    # 规则：同一 IP 5 分钟内失败登录超过 10 次
    cursor.execute("""
    SELECT username, ip_address, COUNT(*) AS attempts
    FROM logs WHERE event='login_failed'
    GROUP BY username, ip_address HAVING attempts > 10
    """)
    
    anomalies = cursor.fetchall()
    results = []

    for anomaly in anomalies:
        results.append({
            "username": anomaly["username"],
            "ip_address": anomaly["ip_address"],
            "reason": "Possible brute-force attack ({} failed attempts)".format(anomaly["attempts"])
        })

    return jsonify({"anomalies": results})
```

---

### **📍 3.3 NLP 处理 API (`routes/nlp_routes.py`)**
```python
from flask import Blueprint, request, jsonify
from services.nlp_processor import convert_to_sql
from models.db import get_db

nlp_bp = Blueprint("nlp", __name__)

@nlp_bp.route("/query", methods=["POST"])
def nlp_query():
    data = request.json
    user_query = data.get("query")

    # 解析自然语言查询
    sql_query = convert_to_sql(user_query)

    conn = get_db()
    cursor = conn.cursor()
    cursor.execute(sql_query)
    results = cursor.fetchall()

    return jsonify({"sql": sql_query, "results": [dict(row) for row in results]})
```

---

## **📌 4. NLP 处理**
### **📍 4.1 NLP 解析 (`services/nlp_processor.py`)**
```python
import re

def convert_to_sql(nlp_query):
    """
    解析自然语言查询，转换为 SQL 语句
    """
    if "最近 24 小时" in nlp_query:
        return "SELECT * FROM logs WHERE timestamp >= datetime('now', '-1 day')"

    if "admin 登录失败" in nlp_query:
        return "SELECT * FROM logs WHERE username='admin' AND event='login_failed'"

    return "SELECT * FROM logs"
```

---

## **📌 5. Web 前端**
### **📍 5.1 日志查询界面 (`templates/index.html`)**
```html
<!DOCTYPE html>
<html>
<head>
    <title>日志查询系统</title>
    <link rel="stylesheet" href="/static/css/bootstrap.min.css">
</head>
<body>
    <div class="container">
        <h2>日志查询</h2>
        <form id="queryForm">
            <input type="text" id="queryInput" class="form-control" placeholder="输入查询语句">
            <button type="submit" class="btn btn-primary">查询</button>
        </form>
        <div id="results"></div>
    </div>

    <script src="/static/js/jquery.min.js"></script>
    <script>
        $("#queryForm").submit(function(event) {
            event.preventDefault();
            let query = $("#queryInput").val();
            $.post("/nlp/query", JSON.stringify({"query": query}), function(data) {
                $("#results").html(JSON.stringify(data.results, null, 2));
            });
        });
    </script>
</body>
</html>
```

---

## **📌 6. 运行项目**
```bash
pip install flask sqlite3
python app.py
```

---

🚀 **本项目代码框架清晰，可直接运行并扩展，欢迎团队开发！** 💡